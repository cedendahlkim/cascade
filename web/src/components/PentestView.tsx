import { useCallback, useEffect, useMemo, useState } from "react";
import { BRIDGE_URL } from "../config";
import {
  Bomb,
  Shield,
  Play,
  RefreshCw,
  FileText,
  Copy,
  Download,
  AlertTriangle,
  Gauge,
  Link as LinkIcon,
} from "lucide-react";

interface WafProfile {
  name: string;
  paranoia: string;
}

interface WafProfilesResponse {
  profiles: WafProfile[];
}

interface WafRecentRun {
  run_id: string;
  status: string;
  started_at: number;
  return_code: number | null;
}

interface WafRecentRunsResponse {
  runs: WafRecentRun[];
}

interface WafRunResult {
  id: string;
  passed: boolean;
  status_code?: number;
  actual_decision?: string;
  expected_decision?: string;
  error?: string;
}

interface WafRunResultsResponse {
  total: number;
  passed: number;
  failed: number;
  pass_rate: number;
  by_category: Record<string, { passed: number; failed: number }>;
  tests: WafRunResult[];
  status?: string;
  running_seconds?: number;
  stale?: boolean;
  message?: string;
}

interface WafRunStartResponse {
  status: string;
  run_id: string | null;
  final_url?: string;
}

interface PentestWafReportResponse {
  run_id: string;
  report_markdown: string;
}

const AUTO_REFRESH_INTERVAL_MS = 5000;

async function readJsonSafely(response: Response): Promise<unknown> {
  const text = await response.text();
  if (!text) return {};
  try {
    return JSON.parse(text);
  } catch {
    return { error: text };
  }
}

function getErrorMessage(data: unknown, fallback: string): string {
  if (data && typeof data === "object") {
    const record = data as Record<string, unknown>;
    const candidate = record.error || record.message || record.detail;
    if (typeof candidate === "string" && candidate.trim().length > 0) {
      return candidate;
    }
  }
  if (typeof data === "string" && data.trim().length > 0) {
    return data;
  }
  return fallback;
}

async function bridgeRequest<T>(path: string, init?: RequestInit): Promise<T> {
  const response = await fetch(`${BRIDGE_URL}${path}`, init);
  const data = await readJsonSafely(response);
  if (!response.ok) {
    throw new Error(getErrorMessage(data, `HTTP ${response.status}`));
  }
  return data as T;
}

function formatDuration(seconds: number): string {
  const safe = Math.max(0, Math.floor(seconds));
  const minutes = Math.floor(safe / 60);
  const remaining = safe % 60;
  if (minutes <= 0) return `${remaining}s`;
  return `${minutes}m ${remaining}s`;
}

export default function PentestView() {
  const [profiles, setProfiles] = useState<WafProfile[]>([]);
  const [selectedProfile, setSelectedProfile] = useState("pl2");
  const [targetBaseUrl, setTargetBaseUrl] = useState("http://localhost:18080");
  const [tags, setTags] = useState("sqli,xss,ssrf,rce");
  const [excludeTags, setExcludeTags] = useState("");
  const [ids, setIds] = useState("");
  const [concurrency, setConcurrency] = useState(2);

  const [recentRuns, setRecentRuns] = useState<WafRecentRun[]>([]);
  const [selectedRunId, setSelectedRunId] = useState<string | null>(null);
  const [runResults, setRunResults] = useState<WafRunResultsResponse | null>(null);

  const [busyInit, setBusyInit] = useState(true);
  const [busyStart, setBusyStart] = useState(false);
  const [busyRun, setBusyRun] = useState(false);
  const [busyReport, setBusyReport] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [reportMarkdown, setReportMarkdown] = useState("");
  const [reportRunId, setReportRunId] = useState<string | null>(null);

  const selectedRun = useMemo(
    () => recentRuns.find((r) => r.run_id === selectedRunId) || null,
    [recentRuns, selectedRunId],
  );

  const selectedRunIsActive = selectedRun?.status === "running";
  const isSelectedRunRunning = selectedRunIsActive || runResults?.status === "running" || runResults?.status === "stalled";

  const refreshProfiles = useCallback(async () => {
    const data = await bridgeRequest<WafProfilesResponse>("/api/waf/profiles");
    const list = data.profiles || [];
    setProfiles(list);
    if (list.length > 0 && !list.some((p) => p.name === selectedProfile)) {
      setSelectedProfile(list[0].name);
    }
  }, [selectedProfile]);

  const refreshRecentRuns = useCallback(async () => {
    const data = await bridgeRequest<WafRecentRunsResponse>("/api/waf/recent-runs");
    const runs = data.runs || [];
    setRecentRuns(runs);
    if (runs.length === 0) {
      setSelectedRunId(null);
      return;
    }

    if (!selectedRunId || !runs.some((r) => r.run_id === selectedRunId)) {
      setSelectedRunId(runs[0].run_id);
    }
  }, [selectedRunId]);

  const refreshRunResults = useCallback(async (runId: string) => {
    const data = await bridgeRequest<WafRunResultsResponse>(`/api/waf/run/${encodeURIComponent(runId)}/results`);
    setRunResults(data);
  }, []);

  const refreshAll = useCallback(async () => {
    setError(null);
    await Promise.all([refreshProfiles(), refreshRecentRuns()]);
  }, [refreshProfiles, refreshRecentRuns]);

  useEffect(() => {
    setBusyInit(true);
    void refreshAll().catch((err) => {
      setError(err instanceof Error ? err.message : String(err));
    }).finally(() => setBusyInit(false));
  }, [refreshAll]);

  useEffect(() => {
    if (!selectedRunId) {
      setRunResults(null);
      return;
    }

    void refreshRunResults(selectedRunId).catch((err) => {
      setError(err instanceof Error ? err.message : String(err));
      setRunResults(null);
    });

    if (!selectedRunIsActive) return;

    const timer = window.setInterval(() => {
      void refreshRunResults(selectedRunId).catch((err) => {
        setError(err instanceof Error ? err.message : String(err));
      });
    }, AUTO_REFRESH_INTERVAL_MS);

    return () => window.clearInterval(timer);
  }, [refreshRunResults, selectedRunId, selectedRunIsActive]);

  const startWaf = async () => {
    setBusyStart(true);
    setError(null);
    try {
      await bridgeRequest("/api/waf/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ profile: selectedProfile }),
      });
    } finally {
      setBusyStart(false);
    }
  };

  const runPentest = async () => {
    setBusyRun(true);
    setError(null);

    try {
      const payload = {
        base_url: targetBaseUrl.trim() || "http://localhost:18080",
        tags: tags.trim(),
        exclude_tags: excludeTags.trim(),
        ids: ids.trim(),
        concurrency,
      };

      const data = await bridgeRequest<WafRunStartResponse>("/api/waf/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      await refreshRecentRuns();

      if (data.run_id) {
        setSelectedRunId(data.run_id);
        setReportMarkdown("");
        setReportRunId(null);
      }
    } finally {
      setBusyRun(false);
    }
  };

  const generateReport = async () => {
    if (!selectedRunId) return;

    setBusyReport(true);
    setError(null);

    try {
      const data = await bridgeRequest<PentestWafReportResponse>("/api/pentest/waf/report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          run_id: selectedRunId,
          base_url: targetBaseUrl.trim() || "http://localhost:18080",
          profile: selectedProfile,
          tags: tags.trim(),
        }),
      });

      setReportMarkdown((data.report_markdown || "").trim());
      setReportRunId(data.run_id || selectedRunId);
    } finally {
      setBusyReport(false);
    }
  };

  const copyReport = async () => {
    if (!reportMarkdown) return;
    await navigator.clipboard.writeText(reportMarkdown);
  };

  const downloadReport = () => {
    if (!reportMarkdown) return;
    const blob = new Blob([reportMarkdown], { type: "text/markdown;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `pentest-${reportRunId || "report"}.md`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  const passRate = useMemo(() => {
    if (!runResults || runResults.total <= 0) return 0;
    return Math.round((runResults.passed / runResults.total) * 100);
  }, [runResults]);

  const busy = busyInit || busyStart || busyRun || busyReport;

  return (
    <div className="flex-1 overflow-y-auto px-3 py-4 space-y-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Bomb className="w-5 h-5 text-amber-300" />
          <h2 className="text-lg font-semibold text-white">Pentest</h2>
        </div>
        <button
          onClick={() => void refreshAll()}
          disabled={busy}
          className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs text-slate-200 disabled:opacity-50"
        >
          <RefreshCw className={`w-3.5 h-3.5 ${busyInit ? "animate-spin" : ""}`} />
          Uppdatera
        </button>
      </div>

      <div className="text-[11px] text-slate-400">
        Kör WAF Hardening corpus mot en target och generera en Markdown-rapport med Frankenstein.
      </div>

      {error && (
        <div className="text-xs text-red-300 bg-red-900/20 border border-red-800/40 rounded-lg px-3 py-2">
          {error}
        </div>
      )}

      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-3 space-y-3">
        <div className="flex items-center gap-2 text-sm font-medium text-slate-200">
          <LinkIcon className="w-4 h-4 text-cyan-300" />
          Target & profil
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
          <div>
            <label className="text-[11px] text-slate-400 block mb-1">Profil</label>
            <select
              value={selectedProfile}
              onChange={(e) => setSelectedProfile(e.target.value)}
              disabled={busy}
              title="WAF profile"
              aria-label="WAF profile"
              className="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-2.5 py-2 text-sm"
            >
              {profiles.map((p) => (
                <option key={p.name} value={p.name}>{p.name} (PL{p.paranoia})</option>
              ))}
            </select>
          </div>

          <div className="md:col-span-2">
            <label className="text-[11px] text-slate-400 block mb-1">Target base URL</label>
            <input
              value={targetBaseUrl}
              onChange={(e) => setTargetBaseUrl(e.target.value)}
              disabled={busy}
              className="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-2.5 py-2 text-sm"
              placeholder="http://localhost:18080"
            />
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input
            value={tags}
            onChange={(e) => setTags(e.target.value)}
            disabled={busy}
            className="bg-slate-900/70 border border-slate-700 rounded-lg px-2.5 py-2 text-xs"
            placeholder="tags, t.ex: sqli,xss,ssrf,rce"
          />
          <input
            value={excludeTags}
            onChange={(e) => setExcludeTags(e.target.value)}
            disabled={busy}
            className="bg-slate-900/70 border border-slate-700 rounded-lg px-2.5 py-2 text-xs"
            placeholder="exclude_tags (valfritt)"
          />
          <input
            value={ids}
            onChange={(e) => setIds(e.target.value)}
            disabled={busy}
            className="bg-slate-900/70 border border-slate-700 rounded-lg px-2.5 py-2 text-xs"
            placeholder="ids (valfritt)"
          />
          <div className="flex items-center gap-2 bg-slate-900/70 border border-slate-700 rounded-lg px-2.5 py-2">
            <Gauge className="w-4 h-4 text-slate-400" />
            <input
              type="number"
              min={1}
              max={64}
              value={concurrency}
              onChange={(e) => setConcurrency(Math.max(1, Math.min(64, Number(e.target.value) || 1)))}
              disabled={busy}
              className="w-full bg-transparent text-xs outline-none"
              placeholder="concurrency"
            />
          </div>
        </div>

        <div className="flex flex-wrap items-center gap-2">
          <button
            onClick={() => { void startWaf(); }}
            disabled={busy}
            className="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg bg-cyan-700 hover:bg-cyan-600 text-xs font-medium text-white disabled:opacity-50"
          >
            <Shield className="w-3.5 h-3.5" />
            {busyStart ? "Startar..." : "Starta WAF"}
          </button>

          <button
            onClick={() => { void runPentest(); }}
            disabled={busy}
            className="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg bg-emerald-700 hover:bg-emerald-600 text-xs font-medium text-white disabled:opacity-50"
          >
            <Play className="w-3.5 h-3.5" />
            {busyRun ? "Kör..." : "Kör pentest"}
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
        <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-3">
          <div className="text-sm font-medium text-slate-200 mb-2">Senaste körningar</div>
          {recentRuns.length === 0 ? (
            <div className="text-xs text-slate-500">Inga körningar ännu.</div>
          ) : (
            <div className="space-y-1.5 max-h-72 overflow-y-auto">
              {recentRuns.map((run) => (
                <button
                  key={run.run_id}
                  onClick={() => setSelectedRunId(run.run_id)}
                  className={`w-full text-left px-2.5 py-2 rounded-lg border text-xs transition-colors ${selectedRunId === run.run_id ? "border-amber-500/70 bg-amber-900/10 text-amber-200" : "border-slate-700 bg-slate-900/40 text-slate-300 hover:border-slate-500"}`}
                >
                  <div className="flex items-center justify-between gap-2">
                    <span className="font-mono truncate">{run.run_id}</span>
                    <span className={`px-1.5 py-0.5 rounded ${run.status === "running" ? "bg-amber-900/40 text-amber-300" : run.return_code === 0 ? "bg-emerald-900/40 text-emerald-300" : "bg-rose-900/40 text-rose-300"}`}>
                      {run.status === "running" ? "kör" : run.return_code === 0 ? "ok" : "fail"}
                    </span>
                  </div>
                  <div className="text-[10px] text-slate-500 mt-0.5">
                    {new Date(run.started_at * 1000).toLocaleString("sv-SE")}
                  </div>
                </button>
              ))}
            </div>
          )}
        </div>

        <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-3 space-y-2">
          <div className="text-sm font-medium text-slate-200">Resultat</div>

          {!selectedRunId ? (
            <div className="text-xs text-slate-500">Välj en körning för att se status.</div>
          ) : isSelectedRunRunning ? (
            <div className="flex items-center gap-2 text-xs text-amber-300">
              <RefreshCw className="w-3.5 h-3.5 animate-spin" />
              {runResults?.message || "Körning pågår..."}
            </div>
          ) : !runResults ? (
            <div className="text-xs text-slate-500">Inga resultat ännu.</div>
          ) : (
            <div className="space-y-2">
              <div className="grid grid-cols-4 gap-2 text-center">
                <div className="bg-slate-900/60 rounded-lg p-2">
                  <div className="text-[10px] text-slate-500">Totalt</div>
                  <div className="text-sm font-bold text-white">{runResults.total}</div>
                </div>
                <div className="bg-slate-900/60 rounded-lg p-2">
                  <div className="text-[10px] text-slate-500">Pass</div>
                  <div className="text-sm font-bold text-emerald-400">{runResults.passed}</div>
                </div>
                <div className="bg-slate-900/60 rounded-lg p-2">
                  <div className="text-[10px] text-slate-500">Fail</div>
                  <div className="text-sm font-bold text-rose-400">{runResults.failed}</div>
                </div>
                <div className="bg-slate-900/60 rounded-lg p-2">
                  <div className="text-[10px] text-slate-500">Pass-rate</div>
                  <div className="text-sm font-bold text-amber-200">{passRate}%</div>
                </div>
              </div>

              {(runResults.tests || []).filter((t) => !t.passed).slice(0, 6).map((t) => (
                <div key={t.id} className="flex items-start gap-2 text-[11px] bg-rose-900/10 border border-rose-800/30 rounded px-2 py-1.5">
                  <AlertTriangle className="w-3.5 h-3.5 text-rose-400 mt-0.5 shrink-0" />
                  <div className="min-w-0">
                    <div className="text-rose-300 font-mono truncate">{t.id}</div>
                    <div className="text-slate-400 truncate">
                      {t.error || `${t.expected_decision || "?"} -> ${t.actual_decision || "?"} (HTTP ${t.status_code || "?"})`}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {typeof runResults?.running_seconds === "number" && runResults.running_seconds > 0 && (
            <div className="text-[11px] text-slate-500">
              Runtime: {formatDuration(runResults.running_seconds)}
            </div>
          )}
        </div>
      </div>

      <div className="bg-slate-800/60 border border-slate-700/50 rounded-xl p-3 space-y-2">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2 text-sm font-medium text-slate-200">
            <FileText className="w-4 h-4 text-cyan-300" />
            Rapport (Frankenstein)
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={() => { void generateReport(); }}
              disabled={busy || !selectedRunId}
              className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-cyan-700 hover:bg-cyan-600 text-xs text-white disabled:opacity-50"
            >
              <FileText className="w-3.5 h-3.5" />
              {busyReport ? "Genererar..." : "Generera"}
            </button>
            <button
              onClick={() => { void copyReport(); }}
              disabled={!reportMarkdown}
              className="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs text-slate-200 disabled:opacity-50"
              title="Kopiera"
            >
              <Copy className="w-3.5 h-3.5" />
              Kopiera
            </button>
            <button
              onClick={downloadReport}
              disabled={!reportMarkdown}
              className="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs text-slate-200 disabled:opacity-50"
              title="Ladda ner .md"
            >
              <Download className="w-3.5 h-3.5" />
              .md
            </button>
          </div>
        </div>

        <div className="text-[11px] text-slate-400">
          Rapporten baseras på WAF-corpus-resultat (inte full nätverks-pentest).
        </div>

        {!selectedRunId ? (
          <div className="text-xs text-slate-500">Välj en körning först.</div>
        ) : busyReport ? (
          <div className="flex items-center gap-2 text-xs text-cyan-200">
            <RefreshCw className="w-3.5 h-3.5 animate-spin" />
            Frankenstein skriver rapport...
          </div>
        ) : reportMarkdown ? (
          <pre className="text-[11px] text-slate-200 bg-slate-900/70 border border-slate-700 rounded-lg p-2 whitespace-pre-wrap max-h-96 overflow-y-auto">
            {reportMarkdown}
          </pre>
        ) : (
          <div className="text-xs text-slate-500">Ingen rapport ännu.</div>
        )}
      </div>
    </div>
  );
}
